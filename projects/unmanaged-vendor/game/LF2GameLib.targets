<Project>
  <Target Name="PackGameLibraries">
    <ItemGroup>
      <_GameLibrarySourceDir Include="$(MSBuildThisFileDirectory)Taiwu.*" />
    </ItemGroup>

    <Message Text="Found @(_GameLibrarySourceDir->Count()) game library directories to pack." Importance="high" />

    <ItemGroup>
      <PackageToCreate Include="@(_GameLibrarySourceDir)">
        <PackageName>%(Filename)</PackageName>
        <PackageId>LF2.%(Filename)</PackageId>
        <LF2PackageType Condition=" Exists('%(Identity)/lib/backend') and  Exists('%(Identity)/lib/frontend')">common</LF2PackageType>
        <LF2PackageType Condition=" Exists('%(Identity)/lib/backend') and !Exists('%(Identity)/lib/frontend')">backend-only</LF2PackageType>
        <LF2PackageType Condition="!Exists('%(Identity)/lib/backend') and  Exists('%(Identity)/lib/frontend')">frontend-only</LF2PackageType>
      </PackageToCreate>
    </ItemGroup>

    <ItemGroup>
      <_InvalidPackage Include="@(PackageToCreate)" Condition="'%(LF2PackageType)' == ''" />
      <PackageToCreate Remove="@(_InvalidPackage)" />
    </ItemGroup>

    <Warning Text="Skipping package '%(_InvalidPackage.PackageName)' because its type could not be determined (neither 'lib/backend' nor 'lib/frontend' exist)." Condition="'@(_InvalidPackage)' != ''" />

    <Message Text="Packing %(PackageToCreate.PackageId) from %(PackageToCreate.PackageName) as %(PackageToCreate.LF2PackageType)..." Importance="high" />

    <ItemGroup>
      <_Properties Include="PackageId=%(PackageToCreate.PackageId)" />
      <_Properties Include="LF2PackageDir=%(PackageToCreate.Identity)" />
      <_Properties Include="LF2PackageType=%(PackageToCreate.LF2PackageType)" />
      <_Properties Include="Version=$(Version);PackageVersion=$(Version)" />
    </ItemGroup>

    <MSBuild
      Projects="$(MSBuildThisFileDirectory)Template.csproj"
      Targets="Pack"
      Properties="@(_PackageBuildProperties)"
    />
  </Target>
</Project>