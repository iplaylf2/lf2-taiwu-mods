name: On Pre-Merge to Master

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [master]

jobs:
  build-check:
    name: Build Check
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_NOLOGO: true
    steps:
      - name: Set Configuration
        id: config
        run: |
          set -euo pipefail

          sln_root_dir="."
          property_source_project_abs=$(
            find "$sln_root_dir/projects/mods" -type f -name '*.csproj' -print \
              | LC_ALL=C sort \
              | head -n 1
          )

          if [ -z "$property_source_project_abs" ]; then
            echo "::error::Unable to locate a property source project under '$sln_root_dir/projects/mods'."
            exit 1
          fi

          property_source_project_rel=$(realpath --relative-to="$sln_root_dir" "$property_source_project_abs")

          {
            printf 'sln_root_dir=%s\n' "$sln_root_dir"
            printf 'property_source_project=%s\n' "$property_source_project_rel"
            printf 'relative_artifacts_path=%s\n' "artifacts/bin/*/release"
          } >> "$GITHUB_OUTPUT"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mod Environment
        uses: ./.github/actions/setup-mod-env

      - name: Build Solution
        run: |
          set -euo pipefail
          sln_root_dir="${{ steps.config.outputs.sln_root_dir }}"
          (cd "$sln_root_dir" && dotnet build -c Release)

      - name: Get Full Artifacts Path
        id: get-path
        run: |
          set -euo pipefail
          source_project="${{ steps.config.outputs.property_source_project }}"
          relative_path="${{ steps.config.outputs.relative_artifacts_path }}"
          sln_root_dir="${{ steps.config.outputs.sln_root_dir }}"
          mods_dir=$(cd "$sln_root_dir" && dotnet msbuild "$source_project" -getProperty:LF2ModsDir)
          echo "path=$mods_dir/$relative_path" >> $GITHUB_OUTPUT

      - name: Upload Mod Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mod-build-artifacts-pr-${{ github.event.pull_request.number }}
          path: ${{ steps.get-path.outputs.path }}
          retention-days: 7
