# NuGet 源管理指南

本指南汇集了在使用本地或远程 NuGet 源时，涉及包安全、源管理、版本控制及常见问题排查的进阶内容。

## 远程源：安全与客户端配置

此章节仅适用于远程源方案。

### 确保包的私有性

由于重新分发游戏文件存在法律风险，将这些依赖包设为**私有**至关重要。

包的默认可见性取决于仓库的所有者：

- **组织仓库**：在公开仓库中发布的包，默认可见性是**私有**的。这是最安全的情况。
- **个人仓库**：在公开仓库中发布的包，默认可见性是**公开**的。**这会带来法律风险**，你必须采取额外步骤确保其私有性。

如果你的仓库是**个人仓库**，你有两种方法处理首次发布的可见性问题。

#### 方法一：手动设置

在工作流完成**第一次**发布后，立刻访问你的 GitHub Packages 页面，找到新发布的包，进入其设置页面，将可见性手动更改为**私有**。

#### 方法二：利用私有仓库

这是一个一次性的便捷技巧，适合在项目初始化时使用。

在**首次**运行工作流之前，将你的仓库临时设置为**私有**。这样，发布的包将自动成为私有包。发布完成后，你可以再将仓库设为公开。

### 配置本地开发环境

发布完成后，在本地配置 NuGet 源以使用远程包。

#### GitHub Packages 源配置

如果使用默认的 GitHub Packages：

1. 打开仓库根目录的 `nuget.config` 文件
2. 在 `<packageSources>` 节中添加：

    ```xml
    <add key="YourUsername" value="https://nuget.pkg.github.com/YourUsername/index.json" />
    ```

3. 配置访问凭据：
    - 设置环境变量 `GITHUB_USERNAME` 为你的 GitHub 用户名
    - 设置环境变量 `GITHUB_TOKEN` 为有 `read:packages` 权限的 PAT

4. 恢复依赖：

    ```bash
    dotnet restore
    ```

#### 自定义 NuGet 源配置

如果推送到自定义 NuGet 源：

1. 在 `nuget.config` 中添加对应的源地址
2. 根据源的要求配置相应的访问凭据
3. 运行 `dotnet restore` 验证配置

## 通用管理操作

### 在不同源之间切换

#### 从本地源切换到远程源

完成本地开发后，如需切换回远程源：

```bash
dotnet nuget disable source local
dotnet restore
```

#### 从远程源切换到本地源

如果需要从远程源切换回本地源：

1. 禁用远程源（在 `nuget.config` 中注释掉或删除对应的 `<add>` 条目）
2. 按照本地源方案操作指南配置本地源
3. 运行 `dotnet restore`

### 本地源配置说明

本地源的配置在根目录的 `nuget.config` 文件中：

```xml
<packageSources>
  <add key="local" value="./.lf2.nupkg" />
  <!-- 其他源配置 -->
</packageSources>
```

`dotnet nuget enable/disable source local` 命令会控制此源的可用性。

### 游戏依赖版本管理

#### 升级游戏版本

1. 重新整理新版本的游戏 DLL 文件
2. 更新压缩包并重新上传（仅远程源方案）
3. 使用新的版本号重新运行工作流（仅远程源方案）
4. 在本地更新 `LF2TaiwuVersion` 属性并重新恢复依赖

#### 回滚版本

1. 在仓库的 `nuget.config` 中指定明确的包版本
2. 或使用 `dotnet restore --force` 强制恢复指定版本

## 故障排除

### 远程源方案

**问题**：工作流执行失败，报告下载错误

- **解决**：检查 `LF2_GAME_LIBS_URL` 机密是否正确设置，确保压缩包可访问
- **检查**：确认压缩包格式正确，包含完整的 `game/` 目录结构

**问题**：NuGet 包推送失败

- **解决**：验证目标源的访问凭据配置正确
- **检查**：确认包版本号符合规范，没有版本冲突
- **检查**：如果指定了自定义 `Source`，确认 `LF2_NUGET_API_KEY` 机密已正确设置

**问题**：`dotnet restore` 找不到远程包

- **解决**：检查 `nuget.config` 中的源地址配置
- **验证**：确认访问凭据（环境变量或配置文件）正确设置

### 本地方案

**问题**：`dotnet restore` 报告找不到包

- **解决**：确认第一步的 DLL 整理已完成，且第二步的打包操作成功执行
- **检查**：查看 `.lf2.nupkg/` 目录是否生成了 `.nupkg` 文件

**问题**：FileCourier 执行失败

- **解决**：确认游戏安装目录路径正确，且具有读取权限
- **检查**：确保 `game-libs.manifest.yaml` 文件存在且格式正确

**问题**：本地包版本不匹配

- **解决**：重新执行第二步的打包操作生成新版本
- **注意**：游戏更新后需要重新整理所有 DLL 文件
